<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI widget chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: transparent !important;
      -webkit-app-region: drag;
    }
    #chat-container {
      transition: opacity 0.3s ease;
    }
    #chat-container.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #chat-output {
      max-height: 320px;
    }
    ::-webkit-scrollbar {
      width: 5px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 5px;
    }

    /* Help Panel styling */
    #help-panel {
      display: none;
      position: fixed;
      top: 12px;
      right: 4px;
      width: 250px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 12px;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      z-index: 100;
    }
  </style>
</head>
<body class="antialiased text-white">

  <!-- Chat container -->
  <div id="chat-container" class="fixed top-0 left-0 right-0 mx-auto w-[800px] bg-black bg-opacity-50 rounded-b-lg shadow-lg flex flex-col p-2">
    <div class="flex-1 overflow-y-auto mb-1" id="chat-output"></div>
    <input
      type="text"
      id="chat-input"
      placeholder="Ask something..."
      class="w-full bg-gray-800 bg-opacity-70 text-white placeholder-gray-400 rounded p-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
      autocomplete="off"
    />
  </div>

  <!-- Help Panel -->
  <div id="help-panel">
    <p class="mb-1">Ctrl + Shift + X = close/open widget</p>
    <p>Ctrl + R = clear messages</p>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const fetch = require('node-fetch');

    const chatContainer = document.getElementById('chat-container');
    const chatOutput = document.getElementById('chat-output');
    const chatInput = document.getElementById('chat-input');
    const helpPanel = document.getElementById('help-panel');

    const messageHistory = [
      { role: 'system', content: 'You are a helpful assistant.' }
    ];

    ipcRenderer.on('toggle-visibility', () => {
      chatContainer.classList.toggle('hidden');
      helpPanel.style.display = 'none';
    });

    ipcRenderer.on('clear-chat', () => {
      chatOutput.innerHTML = '';
      messageHistory.length = 1;
    });

    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'X') {
        chatContainer.classList.toggle('hidden');
        if (helpPanel.style.display === 'none' || helpPanel.style.display === '') {
          helpPanel.style.display = 'block';
        } else {
          helpPanel.style.display = 'none';
        }
      }
    });

    chatInput.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter' && chatInput.value.trim()) {
        const userMessage = chatInput.value.trim();
        appendMessage('You', userMessage);
        chatInput.value = '';

        try {
          const response = await getGroqResponse(userMessage);
          appendMessage('AI', response);
          resizeWindow();
        } catch (error) {
          appendMessage('AI', 'Error: Could not get response.');
          console.error(error);
          resizeWindow();
        }
      }
    });

    function appendMessage(sender, message) {
      const messageDiv = document.createElement('div');
      if (sender === 'You') {
        messageDiv.className = 'text-blue-300 text-sm font-medium mb-1';
      } else {
        messageDiv.className = 'text-gray-100 text-base font-medium mb-1';
      }
      messageDiv.innerHTML = `<strong>${sender}:</strong> ${message.replace(/\n/g, '<br>')}`;
      chatOutput.appendChild(messageDiv);
      chatOutput.scrollTop = chatOutput.scrollHeight;
    }

    function resizeWindow() {
      const minHeight = 50;
      const maxHeight = 400;
      const contentHeight = chatOutput.scrollHeight + 60;
      const newHeight = Math.min(Math.max(contentHeight, minHeight), maxHeight);
      ipcRenderer.send('resize-window', newHeight);
    }

    async function getGroqResponse(userMessage) {
      messageHistory.push({ role: 'user', content: userMessage });

      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer api key!`
        },
        body: JSON.stringify({
          model: 'llama-3.3-70b-versatile',
          messages: messageHistory,
          max_tokens: 1000,
          temperature: 0.7
        })
      });

      const data = await response.json();
      if (data.choices && data.choices[0]) {
        const aiMessage = data.choices[0].message.content.trim();
        messageHistory.push({ role: 'assistant', content: aiMessage });
        return aiMessage;
      }

      throw new Error('No response from AI');
    }
  </script>
</body>
</html>
